-- AÑO A INFORMAR
VARIABLE b_anno NUMBER;
EXEC :b_anno := EXTRACT(YEAR FROM SYSDATE) - 1;

DECLARE
  ---------------------------------------------------------------------------
  -- tipos de transacción
  ---------------------------------------------------------------------------
  TYPE t_varray_tipos IS VARRAY(2) OF VARCHAR2(50);
  v_tipos t_varray_tipos := t_varray_tipos('Avance en Efectivo', 'Súper Avance en Efectivo');

  ---------------------------------------------------------------------------
  -- RECORD
  ---------------------------------------------------------------------------
  TYPE r_transac IS RECORD (
    numrun CLIENTE.numrun%TYPE,
    dvrun CLIENTE.dvrun%TYPE,
    nro_tarjeta TARJETA_CLIENTE.nro_tarjeta%TYPE,
    nro_transaccion TRANSACCION_TARJETA_CLIENTE.nro_transaccion%TYPE,
    fecha_trans TRANSACCION_TARJETA_CLIENTE.fecha_transaccion%TYPE,
    tipo_trans TIPO_TRANSACCION_TARJETA.nombre_tptran_tarjeta%TYPE,
    monto_total TRANSACCION_TARJETA_CLIENTE.monto_total_transaccion%TYPE
  );
  v_row r_transac;

  ---------------------------------------------------------------------------
  -- Contadores para COMMIT/ROLLBACK
  ---------------------------------------------------------------------------
  v_total_registros NUMBER := 0;
  v_procesados NUMBER := 0;

  ---------------------------------------------------------------------------
  -- Variables de cálculo
  ---------------------------------------------------------------------------
  v_porc_aporte TRAMO_APORTE_SBIF.porc_aporte_sbif%TYPE;
  v_aporte NUMBER;

  ---------------------------------------------------------------------------
  -- Cursor 1: detalle (SIN parámetro) + orden obligatorio
  ---------------------------------------------------------------------------
  CURSOR c_detalle IS
    SELECT
      c.numrun,
      c.dvrun,
      tc.nro_tarjeta,
      tr.nro_transaccion,
      tr.fecha_transaccion,
      tt.nombre_tptran_tarjeta AS tipo_transaccion,
      tr.monto_total_transaccion
    FROM TRANSACCION_TARJETA_CLIENTE tr
    JOIN TARJETA_CLIENTE tc
    ON tc.nro_tarjeta = tr.nro_tarjeta
    JOIN CLIENTE c
    ON c.numrun = tc.numrun
    JOIN TIPO_TRANSACCION_TARJETA tt
    ON tt.cod_tptran_tarjeta = tr.cod_tptran_tarjeta
    WHERE EXTRACT(YEAR FROM tr.fecha_transaccion) = :b_anno
    AND tt.nombre_tptran_tarjeta IN (v_tipos(1), v_tipos(2))
    ORDER BY tr.fecha_transaccion ASC, c.numrun ASC;

  ---------------------------------------------------------------------------
  -- Cursor 2: resumen (CON parámetro) desde DETALLE_APORTE_SBIF
  ---------------------------------------------------------------------------
  CURSOR c_resumen(p_mes_anno VARCHAR2, p_tipo VARCHAR2) IS
    SELECT
      SUM(monto_transaccion) AS monto_total,
      SUM(aporte_sbif) AS aporte_total
    FROM DETALLE_APORTE_SBIF
    WHERE TO_CHAR(fecha_transaccion, 'MMYYYY') = p_mes_anno
      AND tipo_transaccion = p_tipo;

  ---------------------------------------------------------------------------
  -- Excepciones (3 obligatorias)
  ---------------------------------------------------------------------------
  e_tabla_inexistente EXCEPTION; -- no predefinida (mapeada)
  PRAGMA EXCEPTION_INIT(e_tabla_inexistente, -942);

  e_proceso_incompleto EXCEPTION; -- definida

BEGIN
  ---------------------------------------------------------------------------
  -- TRUNCATE obligatorio
  ---------------------------------------------------------------------------
  EXECUTE IMMEDIATE 'TRUNCATE TABLE DETALLE_APORTE_SBIF';
  EXECUTE IMMEDIATE 'TRUNCATE TABLE RESUMEN_APORTE_SBIF';

  ---------------------------------------------------------------------------
  -- Total esperado para validar commit
  ---------------------------------------------------------------------------
  SELECT COUNT(*)
    INTO v_total_registros
  FROM TRANSACCION_TARJETA_CLIENTE tr
  JOIN TIPO_TRANSACCION_TARJETA tt
    ON tt.cod_tptran_tarjeta = tr.cod_tptran_tarjeta
  WHERE EXTRACT(YEAR FROM tr.fecha_transaccion) = :b_anno
    AND tt.nombre_tptran_tarjeta IN (v_tipos(1), v_tipos(2));

  ---------------------------------------------------------------------------
  -- Inserción DETALLE_APORTE_SBIF (aporte calculado en PL/SQL)
  ---------------------------------------------------------------------------
  OPEN c_detalle;
  LOOP
    FETCH c_detalle INTO v_row;
    EXIT WHEN c_detalle%NOTFOUND;

    -- buscar % por tramo usando MONTO_TOTAL_TRANSACCION
    SELECT porc_aporte_sbif
      INTO v_porc_aporte
    FROM TRAMO_APORTE_SBIF
    WHERE v_row.monto_total BETWEEN tramo_inf_av_sav AND tramo_sup_av_sav;

    -- calcular aporte en PL/SQL y redondear a entero
    v_aporte := ROUND(v_row.monto_total * (v_porc_aporte / 100));

    INSERT INTO DETALLE_APORTE_SBIF
      (numrun, dvrun, nro_tarjeta, nro_transaccion, fecha_transaccion,
       tipo_transaccion, monto_transaccion, aporte_sbif)
    VALUES
      (v_row.numrun, v_row.dvrun, v_row.nro_tarjeta, v_row.nro_transaccion, v_row.fecha_trans,
       v_row.tipo_trans, ROUND(v_row.monto_total), v_aporte);

    v_procesados := v_procesados + 1;
  END LOOP;
  CLOSE c_detalle;

  ---------------------------------------------------------------------------
  -- Validación de proceso completo (si falla -> rollback)
  ---------------------------------------------------------------------------
  IF v_procesados <> v_total_registros THEN
    RAISE e_proceso_incompleto;
  END IF;

  ---------------------------------------------------------------------------
  -- Inserción RESUMEN_APORTE_SBIF (orden obligatorio: MES_ANNO, TIPO)
  ---------------------------------------------------------------------------
  FOR r_dist IN (
    SELECT DISTINCT
           TO_CHAR(fecha_transaccion, 'MMYYYY') AS mes_anno,
           tipo_transaccion
    FROM DETALLE_APORTE_SBIF
    ORDER BY TO_CHAR(fecha_transaccion, 'MMYYYY') ASC, tipo_transaccion ASC
  ) LOOP
    DECLARE
      v_monto_total NUMBER;
      v_aporte_total NUMBER;
    BEGIN
      OPEN c_resumen(r_dist.mes_anno, r_dist.tipo_transaccion);
      FETCH c_resumen INTO v_monto_total, v_aporte_total;
      CLOSE c_resumen;

      INSERT INTO RESUMEN_APORTE_SBIF
        (mes_anno, tipo_transaccion, monto_total_transacciones, aporte_total_abif)
      VALUES
  (r_dist.mes_anno,
   r_dist.tipo_transaccion,
   ROUND(NVL(v_monto_total, 0)),
   ROUND(NVL(v_aporte_total, 0)));
    END;
  END LOOP;

  COMMIT;

EXCEPTION
  -- 1) Predefinida 
  WHEN NO_DATA_FOUND THEN
    ROLLBACK;
    DBMS_OUTPUT.PUT_LINE('NO_DATA_FOUND: No existe tramo en TRAMO_APORTE_SBIF para algún monto total.');

  -- 2) No predefinida
  WHEN e_tabla_inexistente THEN
    ROLLBACK;
    DBMS_OUTPUT.PUT_LINE('ORA-00942: Tabla inexistente (verifica nombres / permisos).');

  -- 3) Definida
  WHEN e_proceso_incompleto THEN
    ROLLBACK;
    DBMS_OUTPUT.PUT_LINE('Proceso incompleto: procesados='||v_procesados||' / total='||v_total_registros);

  WHEN OTHERS THEN
    ROLLBACK;
    DBMS_OUTPUT.PUT_LINE('Error inesperado: '||SQLERRM);
END;
/


SELECT COUNT(*) AS filas_detalle
FROM DETALLE_APORTE_SBIF;

SELECT COUNT(*) AS filas_resumen
FROM RESUMEN_APORTE_SBIF;

SELECT *
FROM DETALLE_APORTE_SBIF
ORDER BY fecha_transaccion, numrun;

SELECT *
FROM RESUMEN_APORTE_SBIF
ORDER BY mes_anno, tipo_transaccion;
